import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { Setlist } from '../app/types';

export interface CurrentSetlistContextProps {
  currentSetlist: Setlist | null;
  updateCurrentSetlist: (setlist: Setlist) => void;
  forceRedraw?: number;
}

const CurrentSetlistContext = createContext<CurrentSetlistContextProps>({currentSetlist: null, updateCurrentSetlist: () => null, forceRedraw: 0});

export const CurrentSetlistProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [currentSetlist, setCurrentSetlist] = useState<Setlist | null>(null);
  const [forceRedraw, setForceRedraw] = useState<number>(0);

  const updateCurrentSetlist = (setlist: Setlist) => {
    setCurrentSetlist(setlist);
    setForceRedraw(forceRedraw + 1);
    if (!chrome?.storage) return;   // Not running in extension context
    chrome.storage.local.set({ activeSetlist: setlist });
  }

  useEffect(() => {
    if (!chrome?.storage) {
      const testSetlist: Setlist = {"songs":[{"album":"Dávam všetko","albumImageURL":"https://4334.sk/wp-content/uploads/2017/04/rieka-zivota_davam-vsetko.jpg","albumURL":"https://4334.sk/albumy/davam-vsetko/","artist":"Rieka Života","artistURL":"https://4334.sk/umelci/rieka-zivota/","slides":[{"content":"Dnes chcel by som ti dať\nto, čo v srdci mám\nDávam na oltár\nk tvojim nohám, kráľov Kráľ","fontSize":5,"textAlign":"center","title":""},{"content":"Dnes kladiem svoje sny\nja sa zriekam svojich právd\nUž nechcem pyšný stáť\nchcem nový život mať","fontSize":5,"textAlign":"center","title":""},{"content":"Dávam všetko\nto, čo mám\ntebe, Kráľ","fontSize":5,"textAlign":"center","title":""},{"content":"Keď túto pieseň hrám\npod krížom stojím sám\nA všetky bohatstvá\nza smeti pokladám","fontSize":5,"textAlign":"center","title":""},{"content":"Chcem poznať teba, Kráľ\nslávu mena, ktoré máš\nTá radosť nekončí\naj keď s tebou trpieť mám","fontSize":5,"textAlign":"center","title":""}],"title":"Dávam všetko","url":"https://4334.sk/piesne/davam-vsetko/"},{"album":"Jediný skutočný Kráľ","albumImageURL":"https://4334.sk/wp-content/uploads/2020/12/martindom-worship_2020_jediny-skutocny-kral_cd.png","albumURL":"https://4334.sk/albumy/jediny-skutocny-kral/","artist":"Martindom Worship","artistURL":"https://4334.sk/umelci/martindom-worship/","slides":[{"content":"Otváram srdce dokorán\nnech prúdi tvoj Duch\nNech prúdi tvoj Duch","fontSize":5,"textAlign":"center","title":""},{"content":"Tam, kde vstúpiš ty\ntma sa vytratí\na strach už nemá moc\novládať každý krok","fontSize":5,"textAlign":"center","title":""},{"content":"Tam, kde vládneš ty\nláska víťazí\na dáva silu ísť","fontSize":5,"textAlign":"center","title":""},{"content":"Tam, kde vstúpiš ty\ntma sa vytratí\na strach už nemá moc\novládať každý krok","fontSize":5,"textAlign":"center","title":""},{"content":"Tam, kde vládneš ty\nláska víťazí\na dáva silu ísť","fontSize":5,"textAlign":"center","title":""},{"content":"So srdcom otvoreným\nznovu bežíme za tebou","fontSize":5,"textAlign":"center","title":""}],"title":"Srdce dokorán","url":"https://4334.sk/piesne/srdce-dokoran/"},{"album":"jedno.tu","albumImageURL":"https://4334.sk/wp-content/uploads/2020/05/dasa-voskarova_jednotu.jpg","albumURL":"https://4334.sk/albumy/jedno-tu/","artist":"Dáša Voskárová","artistURL":"https://4334.sk/umelci/dasa-voskarova/","slides":[{"content":"Šepkáš mi, šepkáš mi\nneboj sa, poď a vstaň\nŠepkáš mi, šepkáš mi\nmilujem ťa, moje dieťa","fontSize":5,"textAlign":"center","title":""},{"content":"Vydám sa na cestu\nza tebou, Ježiš, tebou, Ježiš\nPo tŕní a skalách\nja pobežím","fontSize":5,"textAlign":"center","title":""},{"content":"A každá krv na nohách\nmi víťazstvom pre teba je\nA každábolesť\nmi dobrým bojom je","fontSize":5,"textAlign":"center","title":""},{"content":"Vo vernosti budem kráčať\ntam kam chceš ty\ntam kam chceš ty\nA tvojím úmyslom ja budem veriť\nže si dobrý, dobrý, dobrý","fontSize":5,"textAlign":"center","title":""},{"content":"(Za tebou pôjdem,) za tebou pôjdem\nza tebou pôjdem, lebo si jediný\nmôjho srdca Kráľ, za tebou pôjdem\nza tebou pôjdem, v dobrom i v zlom\nbudem ťa nasledovať","fontSize":5,"textAlign":"center","title":""}],"title":"Šepkáš mi","url":"https://4334.sk/piesne/sepkas-mi/"},{"album":"jedno.tu","albumImageURL":"https://4334.sk/wp-content/uploads/2020/05/dasa-voskarova_jednotu.jpg","albumURL":"https://4334.sk/albumy/jedno-tu/","artist":"Dáša Voskárová","artistURL":"https://4334.sk/umelci/dasa-voskarova/","slides":[{"content":"I wanna give you so much more\nI don’t want you to live hidden","fontSize":5,"textAlign":"center","title":""},{"content":"Cause I prepared a throne for you\nyou will be sitting right next to me\nYou will be sitting right next to me","fontSize":5,"textAlign":"center","title":""},{"content":"Give me your heart\nI will settle down your thoughts\nGive me your smile\nand I will heal the broken hearts\nGive me your hands\nand I will lead you through this time\nRight into my heart","fontSize":5,"textAlign":"center","title":""},{"content":"Don’t worry child\nyou are my beloved\nDon’t worry child\nI’m the one who is loving first","fontSize":5,"textAlign":"center","title":""},{"content":"Chcem ti dať oveľa viac\n nechcem, aby si žil v skrytosti","fontSize":5,"textAlign":"center","title":""},{"content":"Pripravil som pre teba trón\n budeš sedieť hneď vedľa mňa","fontSize":5,"textAlign":"center","title":""},{"content":"Tak daj mi svoje srdce\n a ja upokojím tvoje myšlienky\n Daj mi svoj úsmev\n a vyliečim ním zlomené srdcia\n Daj mi svoje ruky\n a prevediem ťa týmto časom\n priamo k môjmu srdcu","fontSize":5,"textAlign":"center","title":""},{"content":"Neboj sa, dieťa\n si môj milovaný\n Neboj sa, dieťa\n ja som ten, ktorý miluje prvý","fontSize":5,"textAlign":"center","title":""}],"title":"More","url":"https://4334.sk/piesne/more/"},{"album":"Live Worship 2017","albumImageURL":"https://4334.sk/wp-content/uploads/2018/09/timothy-2018-live_worship_2017.jpg","albumURL":"https://4334.sk/albumy/live-worship-2017/","artist":"Timothy","artistURL":"https://4334.sk/umelci/timothy/","slides":[{"content":"Ty mi dávaš nohy jeleníc\ns tebou naberiem denne nových síl\nS tebou preskočím múry trápenia\na mojej ceste dáš pečať víťazstva","fontSize":5,"textAlign":"center","title":""},{"content":"Kde nádej zomrela, vzkriesenie zatrúbi\na hymnus slobody mi do úst položíš\nNikto už nevezme, čo si mi zasľúbil\nso žalmom na perách zaspávam v pokoji","fontSize":5,"textAlign":"center","title":""},{"content":"Ty mi dávaš nohy jeleníc\ns tebou naberiem denne nových síl\nS tebou preskočím múry trápenia\na mojej ceste dáš pečať víťazstva","fontSize":5,"textAlign":"center","title":""},{"content":"Kde nádej zomrela, vzkriesenie zatrúbi\na hymnus slobody mi do úst položíš\nNikto už nevezme, čo si mi zasľúbil\nso žalmom na perách zaspávam v pokoji","fontSize":5,"textAlign":"center","title":""},{"content":"Nikto už nevezme, čo si mi zasľúbil\nnie, nie\nNikto už nevezme, čo si mi zasľúbil\nnie, nie","fontSize":5,"textAlign":"center","title":""}],"title":"Nohy jeleníc","url":"https://4334.sk/piesne/nohy-jelenic-2017/"},{"album":"Live Worship 2017","albumImageURL":"https://4334.sk/wp-content/uploads/2018/09/timothy-2018-live_worship_2017.jpg","albumURL":"https://4334.sk/albumy/live-worship-2017/","artist":"Timothy","artistURL":"https://4334.sk/umelci/timothy/","slides":[{"content":"Ty mi dávaš nohy jeleníc\ns tebou naberiem denne nových síl\nS tebou preskočím múry trápenia\na mojej ceste dáš pečať víťazstva","fontSize":5,"textAlign":"center","title":""},{"content":"Kde nádej zomrela, vzkriesenie zatrúbi\na hymnus slobody mi do úst položíš\nNikto už nevezme, čo si mi zasľúbil\nso žalmom na perách zaspávam v pokoji","fontSize":5,"textAlign":"center","title":""},{"content":"Ty mi dávaš nohy jeleníc\ns tebou naberiem denne nových síl\nS tebou preskočím múry trápenia\na mojej ceste dáš pečať víťazstva","fontSize":5,"textAlign":"center","title":""},{"content":"Kde nádej zomrela, vzkriesenie zatrúbi\na hymnus slobody mi do úst položíš\nNikto už nevezme, čo si mi zasľúbil\nso žalmom na perách zaspávam v pokoji","fontSize":5,"textAlign":"center","title":""},{"content":"Nikto už nevezme, čo si mi zasľúbil\nnie, nie\nNikto už nevezme, čo si mi zasľúbil\nnie, nie","fontSize":5,"textAlign":"center","title":""}],"title":"Nohy jeleníc","url":"https://4334.sk/piesne/nohy-jelenic-2017/"},{"album":"Live Worship 2017","albumImageURL":"https://4334.sk/wp-content/uploads/2018/09/timothy-2018-live_worship_2017.jpg","albumURL":"https://4334.sk/albumy/live-worship-2017/","artist":"Timothy","artistURL":"https://4334.sk/umelci/timothy/","slides":[{"content":"Ty mi dávaš nohy jeleníc\ns tebou naberiem denne nových síl\nS tebou preskočím múry trápenia\na mojej ceste dáš pečať víťazstva","fontSize":5,"textAlign":"center","title":""},{"content":"Kde nádej zomrela, vzkriesenie zatrúbi\na hymnus slobody mi do úst položíš\nNikto už nevezme, čo si mi zasľúbil\nso žalmom na perách zaspávam v pokoji","fontSize":5,"textAlign":"center","title":""},{"content":"Ty mi dávaš nohy jeleníc\ns tebou naberiem denne nových síl\nS tebou preskočím múry trápenia\na mojej ceste dáš pečať víťazstva","fontSize":5,"textAlign":"center","title":""},{"content":"Kde nádej zomrela, vzkriesenie zatrúbi\na hymnus slobody mi do úst položíš\nNikto už nevezme, čo si mi zasľúbil\nso žalmom na perách zaspávam v pokoji","fontSize":5,"textAlign":"center","title":""},{"content":"Nikto už nevezme, čo si mi zasľúbil\nnie, nie\nNikto už nevezme, čo si mi zasľúbil\nnie, nie","fontSize":5,"textAlign":"center","title":""}],"title":"Nohy jeleníc","url":"https://4334.sk/piesne/nohy-jelenic-2017/"},{"album":"Live Worship 2017","albumImageURL":"https://4334.sk/wp-content/uploads/2018/09/timothy-2018-live_worship_2017.jpg","albumURL":"https://4334.sk/albumy/live-worship-2017/","artist":"Timothy","artistURL":"https://4334.sk/umelci/timothy/","slides":[{"content":"Ty mi dávaš nohy jeleníc\ns tebou naberiem denne nových síl\nS tebou preskočím múry trápenia\na mojej ceste dáš pečať víťazstva","fontSize":5,"textAlign":"center","title":""},{"content":"Kde nádej zomrela, vzkriesenie zatrúbi\na hymnus slobody mi do úst položíš\nNikto už nevezme, čo si mi zasľúbil\nso žalmom na perách zaspávam v pokoji","fontSize":5,"textAlign":"center","title":""},{"content":"Ty mi dávaš nohy jeleníc\ns tebou naberiem denne nových síl\nS tebou preskočím múry trápenia\na mojej ceste dáš pečať víťazstva","fontSize":5,"textAlign":"center","title":""},{"content":"Kde nádej zomrela, vzkriesenie zatrúbi\na hymnus slobody mi do úst položíš\nNikto už nevezme, čo si mi zasľúbil\nso žalmom na perách zaspávam v pokoji","fontSize":5,"textAlign":"center","title":""},{"content":"Nikto už nevezme, čo si mi zasľúbil\nnie, nie\nNikto už nevezme, čo si mi zasľúbil\nnie, nie","fontSize":5,"textAlign":"center","title":""}],"title":"Nohy jeleníc","url":"https://4334.sk/piesne/nohy-jelenic-2017/"},{"album":"jedno.tu","albumImageURL":"https://4334.sk/wp-content/uploads/2020/05/dasa-voskarova_jednotu.jpg","albumURL":"https://4334.sk/albumy/jedno-tu/","artist":"Dáša Voskárová","artistURL":"https://4334.sk/umelci/dasa-voskarova/","slides":[{"content":"Spravodlivosť a plnosť pokoja naveky\nspravodlivosť a plnosť pokoja naveky\nSpravodlivosť a plnosť pokoja naveky\nv tvojich dňoch budú prekvitať naveky","fontSize":5,"textAlign":"center","title":""},{"content":"Daj mi múdrosť hodnú syna Kráľa\nmúdrosť vernú a spravodlivú\nPodľa práva ja túžim seba a blížnych viesť\ncestou spásy a zázrakov lásku niesť","fontSize":5,"textAlign":"center","title":""},{"content":"Pokoj tvoj nech prinesú štíty hôr\nz výšin závan spravodlivý\nV každej núdzi ty právo pridelíš úbohým\ndeťom biednym chlieb podávaš sľúbený","fontSize":5,"textAlign":"center","title":""},{"content":"Svätý Pán, ty hojnosť pokoja máš\nSvätý Kráľ, spravodlivý Otec náš","fontSize":5,"textAlign":"center","title":""}],"title":"Spravodlivosť","url":"https://4334.sk/piesne/spravodlivost/"},{"album":"jedno.tu","albumImageURL":"https://4334.sk/wp-content/uploads/2020/05/dasa-voskarova_jednotu.jpg","albumURL":"https://4334.sk/albumy/jedno-tu/","artist":"Dáša Voskárová","artistURL":"https://4334.sk/umelci/dasa-voskarova/","slides":[{"content":"Pre teba pôjdem do neznáma\nveď s tebou môžem hory prenášať","fontSize":5,"textAlign":"center","title":""},{"content":"Vo veľkej odvahe chcem stáť\nv tvojom mene stáť\nV tvojom mene rásť\nChcem hľadieť len na tvoju tvár\nláskou preniká\n(Láskou prenikám)","fontSize":5,"textAlign":"center","title":""},{"content":"Tak, prosím, tiahni ma\ndo tvojej prítomnosti\nProsím, tiahni ma bližšie\ndo tvojej prítomnosti","fontSize":5,"textAlign":"center","title":""},{"content":"Prosím, tiahni ma, Kráľ\nchcem byť v tvojej prítomnosti\nProsím, tiahni ma bližšie","fontSize":5,"textAlign":"center","title":""}],"title":"Hory prenášať","url":"https://4334.sk/piesne/hory-prenasat/"},{"album":"jedno.tu","albumImageURL":"https://4334.sk/wp-content/uploads/2020/05/dasa-voskarova_jednotu.jpg","albumURL":"https://4334.sk/albumy/jedno-tu/","artist":"Dáša Voskárová","artistURL":"https://4334.sk/umelci/dasa-voskarova/","slides":[{"content":"Šepkáš mi, šepkáš mi\nneboj sa, poď a vstaň\nŠepkáš mi, šepkáš mi\nmilujem ťa, moje dieťa","fontSize":5,"textAlign":"center","title":""},{"content":"Vydám sa na cestu\nza tebou, Ježiš, tebou, Ježiš\nPo tŕní a skalách\nja pobežím","fontSize":5,"textAlign":"center","title":""},{"content":"A každá krv na nohách\nmi víťazstvom pre teba je\nA každábolesť\nmi dobrým bojom je","fontSize":5,"textAlign":"center","title":""},{"content":"Vo vernosti budem kráčať\ntam kam chceš ty\ntam kam chceš ty\nA tvojím úmyslom ja budem veriť\nže si dobrý, dobrý, dobrý","fontSize":5,"textAlign":"center","title":""},{"content":"(Za tebou pôjdem,) za tebou pôjdem\nza tebou pôjdem, lebo si jediný\nmôjho srdca Kráľ, za tebou pôjdem\nza tebou pôjdem, v dobrom i v zlom\nbudem ťa nasledovať","fontSize":5,"textAlign":"center","title":""}],"title":"Šepkáš mi","url":"https://4334.sk/piesne/sepkas-mi/"}]};
      setCurrentSetlist(testSetlist);
      return;   // Not running in extension context
    }
    // Load the current setlist from local storage on startup
    chrome.storage.local.get("activeSetlist", (data) => {
      if (data.activeSetlist) {
        setCurrentSetlist(data.activeSetlist);
      }
    });

    // Listen for updates to the setlist
    const handleMessage = (message: any) => {
      if (message.action === "activeSetlistUpdated") {
        setCurrentSetlist(message.setlist);
      }
    };
    chrome.runtime.onMessage.addListener(handleMessage);

    // Cleanup listener on component unmount
    return () => {
      chrome.runtime.onMessage.removeListener(handleMessage);
    };
  }, []);

  return (
    <CurrentSetlistContext.Provider value={{ currentSetlist, updateCurrentSetlist, forceRedraw }}>
      {children}
    </CurrentSetlistContext.Provider>
  );
};

export const useCurrentSetlistContext = () => useContext(CurrentSetlistContext);

export function withCurrentSetlistContext<T extends CurrentSetlistContextProps = CurrentSetlistContextProps> (Component: React.ComponentType<T>) {
    const displayName = Component.displayName || Component.name || "Component";
    const ComponentWithContext = (props: Omit<T, keyof CurrentSetlistContextProps>) => {
        return (
          <CurrentSetlistContext.Consumer>
            {contextProps => <Component {...contextProps} {...(props as T) }></Component>}
          </CurrentSetlistContext.Consumer>
        );
    };
    ComponentWithContext.displayName = `withCurrentSetlistContext(${displayName})`;
    return ComponentWithContext;
}